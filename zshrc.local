#export ANDROID_SDK_ROOT="$HOME/development/android/sdk"
#export ANDROID_HOME="$ANDROID_SDK_ROOT/"
#export PATH="$PATH:$HOME/development/flutter/bin"
export MAVEN_HOME=/usr/local/apache-maven-3.8.8
#export PATH="$HOMEBREW_PREFIX/opt/opencv@3:$HOMEBREW_PREFIX/opt/opencv@3/bin:$MAVEN_HOME/bin:$PATH"
#!export PATH="$PATH:$HOME/development/cmdline-tools/bin:$ANDROID_SDK_ROOT/platform-tools:$ANDROID_SDK_ROOT/emulator"
export PATH="$MAVEN_HOME/bin:$PATH"
export LD_LIBRARY_PATH=$HOMEBREW_PREFIX/lib
#export CPPFLAGS="-I$HOMEBREW_PREFIX/opt/openjdk/include"
export PKG_CONFIG_PATH="/opt/homebrew/lib/pkgconfig:/usr/local/lib/pkgconfig:$PKG_CONFIG_PATH"
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"  # This loads nvm
[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"  # This loads nvm bash_completion
source $HOME/.local/bin/env
export OCO_ONE_LINE_COMMIT=true
export HOMEBREW_NO_AUTO_UPDATE=1
#export PATH="/opt/homebrew/opt/openjdk@17/bin:$PATH"
export PATH="/opt/homebrew/opt/mysql-client@8.0/bin:$PATH"

#--------------------------------------------------
# GEMINI DAILY LOG FUNCTION FOR NOTION (v2.0)
# Tương thích Zsh/Bash, hỗ trợ ước lượng Pomodoro
#--------------------------------------------------
function log() {
    # --- Định nghĩa Template Gốc ---
    local TEMPLATE_EOD="
- Completed: ?/? po
- Issues:
- Tomorrow: "

    local TEMPLATE_FULL="
Following “The Habits”
Daily Plan (? po):
[Nội dung Daily Plan]

Progress Tracking:
[Nội dung Progress Tracking]

Notes & Links:
[User sẽ tự điền]

End-of-day Report (? po):
- Completed: -/- po
- Issues:
- Tomorrow: "

    # --- Hiển thị Hướng dẫn sử dụng ---
    if [[ "$1" == "help" ]] || [[ "$1" == "--help" ]] || [[ -z "$1" ]]; then
        echo "Cách dùng: log [command] [nội dung memo]"
        echo "Commands:"
        echo "  plan     <memo> : Tạo tasks cho 'Daily Plan' (có ước lượng 'po')"
        echo "  progress <memo> : Ghi nhận cho 'Progress Tracking'"
        echo "  eod      <memo> : Tạo 'End-of-day Report' (có ước lượng 'po' hoàn thành)"
        echo "  full     <memo> : Tạo toàn bộ file log (có ước lượng 'po')"
        echo "  help            : Hiển thị trợ giúp này"
        return 0
    fi

    # --- Xử lý input ---
    local COMMAND=$1
    shift
    local MEMO="$@"
    local PROMPT=""

    if [[ -z "$MEMO" ]]; then
        echo "Lỗi: Cần có nội dung memo."
        log help
        return 1
    fi

    # --- Xây dựng Prompt cho Gemini (ĐÃ CẬP NHẬT) ---
    case "$COMMAND" in
        plan)
            ### --- Thay đổi Prompt 'plan' ---
            PROMPT="Bạn là trợ lý AI. Nhận memo sau và chuyển nó thành các tasks (dùng gạch đầu dòng '-') cho mục 'Daily Plan'.
**Quan trọng: Với mỗi task, hãy ước lượng số Pomodoro (po) cần thiết và ghi ở cuối, ví dụ: '- Task A (2 po)'.**
**Nếu bạn không chắc chắn về số po, hãy thêm dấu chấm hỏi, ví dụ: '(1? po)' hoặc '(2? po)'.**
Chỉ output danh sách các gạch đầu dòng, không giải thích gì thêm.
Memo: \"$MEMO\""
            ;;

        progress)
            # Giữ nguyên prompt 'progress'
            PROMPT="Bạn là trợ lý AI. Nhận memo sau và tóm tắt nó (dùng gạch đầu dòng) cho mục 'Progress Tracking' trong Notion. Giữ văn phong súc tích.
**Quan trọng: Với các task hãy cố gắng chia các task thành công việc cụ thể, ví du: '- Task A thực hiện công việc'**
**Xác định các task công việc cha con rõ ràng và súc tích**
Chỉ output danh sách với các gạch đầu dòng theo từng task cha / con
Memo: \"$MEMO\""
            ;;

        eod)
            ### --- Thay đổi Prompt 'eod' ---
            PROMPT="Bạn là trợ lý AI. Nhận memo sau và điền vào template 'End-of-day Report' sau:
\`\`\`
$TEMPLATE_EOD
\`\`\`
Hãy **suy luận số po 'Completed' (ví dụ: 7/10 po) dựa trên khối lượng công việc trong memo một cách hợp lý nhất.**
**Nếu bạn không chắc chắn về số po đã hoàn thành, bạn có thể ghi '(7?/10 po)' hoặc '(?/10 po)' để người dùng tự điều chỉnh.**
Hãy cũng tự suy luận để điền vào các mục 'Issues' và 'Tomorrow'.
Chỉ output phần template đã điền, không giải thích gì thêm.
Memo: \"$MEMO\""
            ;;

        full)
            ### --- Thay đổi Prompt 'full' ---
            PROMPT="Bạn là trợ lý AI. Dựa vào memo tổng hợp trong ngày sau đây, hãy tạo toàn bộ nội dung cho trang Notion Daily Journal.
Template gốc:
\`\`\`
$TEMPLATE_FULL
\`\`\`
Hãy phân tích memo và điền thông tin vào các mục.
**Yêu cầu quan trọng:**
1.  Khi điền 'Daily Plan', hãy **ước lượng Pomodoro (po) cho mỗi task** (ví dụ: '- Task A (2 po)').
2.  Khi điền 'End-of-day Report', hãy **ước lượng số po đã hoàn thành** (ví dụ: 'Completed: 7/10 po').
3.  **Nếu bạn không chắc chắn về bất kỳ ước lượng po nào, hãy thêm dấu chấm hỏi '?'** (ví dụ: '(2? po)' hoặc 'Completed: 7?/10 po').
4.  Mục 'Notes & Links' để trống.
**Yêu cầu output:** Chỉ output nội dung đã được điền vào template, bắt đầu từ 'Following “The Habits”'. Không giải thích.
Memo tổng hợp: \"$MEMO\""
            ;;

        *)
            echo "Lỗi: Command '$COMMAND' không hợp lệ."
            log help
            return 1
            ;;
    esac

    # --- Gọi Gemini CLI ---
    # (Hãy đảm bảo bạn đã thay thế dòng 'echo ... | gemini'
    # bằng lệnh 'gemini cli' chính xác của bạn)

    echo "Đang xử lý memo với Gemini (v2.0)..." >&2

    #echo "$PROMPT" | gemini
    (cd ~/.gemini-daily && gemini "$PROMPT")
}

#--------------------------------------------------
# GEMINI DAILY LOG FUNCTION FOR NOTION (v3.0)
# Hỗ trợ Zsh/Bash, ước lượng 'po', hỗ trợ Local LLM
#--------------------------------------------------
function loglm() {
    # --- (Phần định nghĩa Template không đổi) ---
    local TEMPLATE_EOD="
- Completed: -/10 po
- Issues:
- Tomorrow: "
    local TEMPLATE_FULL="
Following “The Habits”
Daily Plan (1 po):
[Nội dung Daily Plan]
Progress Tracking:
[Nội dung Progress Tracking]
Notes & Links:
[User sẽ tự điền]
End-of-day Report (1 po):
- Completed: -/10 po
- Issues:
- Tomorrow: "

    # --- (Phần 'help' và xử lý input không đổi) ---
    if [[ "$1" == "help" ]] || [[ "$1" == "--help" ]] || [[ -z "$1" ]]; then
        echo "Cách dùng: log [command] [nội dung memo]"
        echo "Commands:"
        echo "  plan     <memo> : Tạo tasks cho 'Daily Plan' (có ước lượng 'po')"
        echo "  progress <memo> : Ghi nhận cho 'Progress Tracking'"
        echo "  eod      <memo> : Tạo 'End-of-day Report' (có ước lượng 'po' hoàn thành)"
        echo "  full     <memo> : Tạo toàn bộ file log (có ước lượng 'po')"
        echo "  help            : Hiển thị trợ giúp này"
        return 0
    fi
    local COMMAND=$1
    shift
    local MEMO="$@"
    local PROMPT=""
    if [[ -z "$MEMO" ]]; then
        echo "Lỗi: Cần có nội dung memo."
        log help
        return 1
    fi

    # --- (Phần xây dựng Prompt không đổi) ---
    case "$COMMAND" in
        plan)
            PROMPT="Bạn là trợ lý AI. Nhận memo sau và chuyển nó thành các tasks (dùng gạch đầu dòng '-') cho mục 'Daily Plan'.
**Quan trọng: Với mỗi task, hãy ước lượng số Pomodoro (po) cần thiết và ghi ở cuối, ví dụ: '- Task A (2 po)'.**
**Nếu bạn không chắc chắn về số po, hãy thêm dấu chấm hỏi, ví dụ: '(1? po)' hoặc '(2? po)'.**
Chỉ output danh sách các gạch đầu dòng, không giải thích gì thêm.
Memo: \"$MEMO\""
            ;;
        progress)
            PROMPT="Bạn là trợ lý AI. Nhận memo sau và tóm tắt nó (dùng gạch đầu dòng) cho mục 'Progress Tracking' trong Notion. Giữ văn phong súc tích.
**Quan trọng: Với các task hãy cố gắng chia các task thành công việc cụ thể, ví du: '- Task A thực hiện công việc'**
**Xác định các task công việc cha con rõ ràng và súc tích**
Chỉ output danh sách với các gạch đầu dòng theo từng task cha / con
Memo: \"$MEMO\""
            ;;
        eod)
            PROMPT="Bạn là trợ lý AI. Nhận memo sau và điền vào template 'End-of-day Report' sau:
\`\`\`
$TEMPLATE_EOD
\`\`\`
Hãy **suy luận số po 'Completed' (ví dụ: 7/10 po) dựa trên khối lượng công việc trong memo một cách hợp lý nhất.**
**Nếu bạn không chắc chắn về số po đã hoàn thành, bạn có thể ghi '(7?/10 po)' hoặc '(?/10 po)' để người dùng tự điều chỉnh.**
Hãy cũng tự suy luận để điền vào các mục 'Issues' và 'Tomorrow'.
Chỉ output phần template đã điền, không giải thích gì thêm.
Memo: \"$MEMO\""
            ;;
        full)
            PROMPT="Bạn là trợ lý AI. Dựa vào memo tổng hợp trong ngày sau đây, hãy tạo toàn bộ nội dung cho trang Notion Daily Journal.
Template gốc:
\`\`\`
$TEMPLATE_FULL
\`\`\`
Hãy phân tích memo và điền thông tin vào các mục.
**Yêu cầu quan trọng:**
1.  Khi điền 'Daily Plan', hãy **ước lượng Pomodoro (po) cho mỗi task** (ví dụ: '- Task A (2 po)').
2.  Khi điền 'End-of-day Report', hãy **ước lượng số po đã hoàn thành** (ví dụ: 'Completed: 7/10 po').
3.  **Nếu bạn không chắc chắn về bất kỳ ước lượng po nào, hãy thêm dấu chấm hỏi '?'** (ví dụ: '(2? po)' hoặc 'Completed: 7?/10 po').
4.  Mục 'Notes & Links' để trống.
**Yêu cầu output:** Chỉ output nội dung đã được điền vào template, bắt đầu từ 'Following “The Habits”'. Không giải thích.
Memo tổng hợp: \"$MEMO\""
            ;;
        *)
            echo "Lỗi: Command '$COMMAND' không hợp lệ."
            log help
            return 1
            ;;
    esac

    # --- [PHẦN THAY ĐỔI CHÍNH Ở ĐÂY] ---
    # Thay vì gọi 'gemini', chúng ta gọi 'curl' đến LM Studio
    #-------------------------------------------------

    echo "Đang xử lý memo với LM Studio (Local)..." >&2

    # 1. Lấy tên model bạn đã load trong LM Studio
    #    (Ví dụ: "lmstudio-community/Meta-Llama-3-8B-Instruct-GGUF")
    #    !! BẠN PHẢI THAY THẾ GIÁ TRỊ NÀY !!
    local LOCAL_MODEL_NAME="openai/gpt-oss-120b" # "qwen/qwen3-32b" #"unsloth/deepseek-r1-distill-qwen-32b"

    # 2. Xây dựng payload JSON
    #    Chúng ta dùng 'jq' để build JSON một cách an toàn,
    #    đảm bảo $PROMPT có dấu ngắt dòng hay quote đều không bị lỗi.
    local JSON_PAYLOAD
    JSON_PAYLOAD=$(jq -n \
                      --arg prompt_content "$PROMPT" \
                      --arg model_name "$LOCAL_MODEL_NAME" \
                      '{
                          "model": $model_name,
                          "messages": [{"role": "user", "content": $prompt_content}],
                          "temperature": 0.7,
                          "stream": false
                      }')

    # 3. Gọi API bằng curl và dùng jq để trích xuất câu trả lời
    #    - 'curl -s': Chạy ở chế độ im lặng (silent)
    #    - 'jq -r': '-r' là raw-output, để lấy text thuần túy
    #curl -s http://172.16.0.25:1234/v1/chat/completions \
    #     -H "Content-Type: application/json" \
    #     -d "$JSON_PAYLOAD" | jq -r '.choices[0].message.content'

    curl -s http://172.16.0.25:1234/v1/chat/completions \
         -H "Content-Type: application/json" \
         -d "$JSON_PAYLOAD" | \
         jq -r '.choices[0].message.content' | \
         awk -v RS="</think>" '{sub(/<think>.*/, ""); printf "%s", $0}'

    # --- [KẾT THÚC PHẦN THAY ĐỔI] ---
}
